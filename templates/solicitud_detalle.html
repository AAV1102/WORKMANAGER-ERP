{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-clipboard-list"></i> Solicitud #{{ solicitud.id }}</h2>
            <p class="text-muted mb-0">
                Seguimiento de la solicitud registrada el {{ solicitud.fecha_solicitud or 'N/D' }}
            </p>
        </div>
        <div class="text-end">
            <a href="{{ url_for('gestion_humana.solicitudes') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Volver a solicitudes
            </a>
        </div>
    </div>

    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Datos generales</h5>
                <span class="badge
                    {% if solicitud.estado == 'aprobada' %}bg-success
                    {% elif solicitud.estado == 'rechazada' %}bg-danger
                    {% else %}bg-warning text-dark{% endif %}
                ">
                    {{ solicitud.estado|default('Pendiente')|title }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Tipo de solicitud:</strong></p>
                        <p>{{ solicitud.tipo_solicitud or solicitud.tipo or 'No especificado' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Empleado vinculado:</strong></p>
                        {% if empleado %}
                            <p>{{ empleado.nombre }} {{ empleado.apellido }}</p>
                            <p class="text-muted">{{ empleado.cargo or 'Sin cargo' }}</p>
                        {% else %}
                            <p class="text-danger">Empleado no localizado</p>
                        {% endif %}
                    </div>
                </div>
                <hr>
                <p class="mb-1"><strong>Descripción / Justificación</strong></p>
                <p>{{ solicitud.descripcion or 'Sin descripción registrada.' }}</p>
                {% if solicitud.motivo_rechazo %}
                <div class="alert alert-danger">
                    <strong>Motivo de rechazo:</strong><br>
                    {{ solicitud.motivo_rechazo }}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Trazabilidad</h5>
            </div>
            <div class="card-body">
                {% if aprobaciones %}
                    <ul class="list-group list-group-flush">
                        {% for registro in aprobaciones %}
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ registro.decision|title }}</strong>
                                    <p class="mb-1">{{ registro.comentarios or 'Sin comentarios adicionales.' }}</p>
                                </div>
                                <small class="text-muted">{{ registro.created_at or 'Sin fecha' }}</small>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">
                        Aún no hay acciones registradas sobre esta solicitud.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user"></i> Información del empleado</h5>
            </div>
            <div class="card-body">
                {% if empleado %}
                    <p><strong>Nombre:</strong> {{ empleado.nombre }} {{ empleado.apellido }}</p>
                    <p><strong>Cargo:</strong> {{ empleado.cargo or 'Sin cargo' }}</p>
                    <p><strong>Departamento:</strong> {{ empleado.departamento or 'Sin dependencia' }}</p>
                    <p><strong>Cédula:</strong> {{ empleado.cedula or 'N/D' }}</p>
                    <p><strong>Usuario Windows:</strong> {{ empleado.usuario_windows or 'Sin usuario' }}</p>
                    <p><strong>Correo:</strong> {{ empleado.correo_office or 'Sin correo' }}</p>
                {% else %}
                    <p class="text-muted">El empleado asociado no existe o fue eliminado.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Acciones</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('gestion_humana.aprobar_solicitud', solicitud_id=solicitud.id) }}">
                    <button type="submit" class="btn btn-success w-100 mb-2">
                        <i class="fas fa-check"></i> Aprobar solicitud
                    </button>
                </form>
                <form method="POST" action="{{ url_for('gestion_humana.rechazar_solicitud', solicitud_id=solicitud.id) }}">
                    <div class="mb-3">
                        <label for="motivo_rechazo" class="form-label">Motivo del rechazo</label>
                        <textarea class="form-control" id="motivo_rechazo" name="motivo_rechazo" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-times"></i> Rechazar solicitud
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
