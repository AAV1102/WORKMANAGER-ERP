{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-users"></i> Gestión de Usuarios</h2>
        <p class="text-muted">Empleados y usuarios del sistema</p>

        <!-- Botones de acción -->
        <div class="mb-3">
            <button class="btn btn-primary me-2" onclick="nuevoUsuario()"><i class="fas fa-plus"></i> Nuevo Usuario</button>
            <button class="btn btn-success me-2" onclick="exportarSeleccionados('excel')"><i class="fas fa-file-excel"></i> Exportar Excel</button>
            <button class="btn btn-danger me-2" onclick="exportarSeleccionados('pdf')"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
            <button class="btn btn-warning me-2" onclick="asignarEquiposSeleccionados()"><i class="fas fa-boxes"></i> Asignar Equipos</button>
            <button class="btn btn-info me-2" onclick="desactivarSeleccionados()"><i class="fas fa-ban"></i> Desactivar</button>
            <button class="btn btn-secondary me-2" onclick="bloquearSeleccionados()"><i class="fas fa-lock"></i> Bloquear</button>
            <button class="btn btn-dark me-2" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> Eliminar</button>
        </div>

        <!-- Filtros -->
        <div class="row mb-3">
            <form method="get" action="{{ url_for('user.users') }}">
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="searchNombre" name="nombre" class="form-control" placeholder="Buscar por nombre..." value="{{ search_nombre or '' }}">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="searchCedula" name="cedula" class="form-control" placeholder="Buscar por cédula..." value="{{ search_cedula or '' }}">
                    </div>
                    <div class="col-md-3">
                        <select id="filterEstado" name="estado" class="form-control">
                            <option value="">Todos los estados</option>
                            <option value="activo" {% if filter_estado == 'activo' %}selected{% endif %}>Activo</option>
                            <option value="inactivo" {% if filter_estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                            <option value="suspendido" {% if filter_estado == 'suspendido' %}selected{% endif %}>Suspendido</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="filterDepartamento" name="departamento" class="form-control">
                            <option value="">Todos los departamentos</option>
                            <option value="Comercial" {% if filter_departamento == 'Comercial' %}selected{% endif %}>Comercial</option>
                            <option value="Contabilidad" {% if filter_departamento == 'Contabilidad' %}selected{% endif %}>Contabilidad</option>
                            <option value="Financiero" {% if filter_departamento == 'Financiero' %}selected{% endif %}>Financiero</option>
                            <option value="Logística" {% if filter_departamento == 'Logística' %}selected{% endif %}>Logística</option>
                            <option value="Recursos Humanos" {% if filter_departamento == 'Recursos Humanos' %}selected{% endif %}>Recursos Humanos</option>
                            <option value="Sistemas" {% if filter_departamento == 'Sistemas' %}selected{% endif %}>Sistemas</option>
                            <option value="Operaciones" {% if filter_departamento == 'Operaciones' %}selected{% endif %}>Operaciones</option>
                            <option value="Administrativo" {% if filter_departamento == 'Administrativo' %}selected{% endif %}>Administrativo</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Checkbox para selección múltiple -->
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll">
                <label class="form-check-label" for="selectAll">
                    Seleccionar todos
                </label>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllHeader"></th>
                        <th>Foto</th>
                        <th>Nombre Completo</th>
                        <th>Cédula</th>
                        <th>Cargo</th>
                        <th>Departamento</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Estado</th>
                        <th>Performance</th>
                        <th>Fecha Ingreso</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td><input type="checkbox" class="user-checkbox" value="{{ user[0] }}"></td>
                        <td>
                            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                {{ user[2][0] if user[2] else '' }}{{ user[3][0] if user[3] else '' }}
                            </div>
                        </td>
                        <td>{{ user[2] }} {{ user[3] }}</td>
                        <td>{{ user[1] }}</td>
                        <td>{{ user[4] }}</td>
                        <td>{{ user[5] }}</td>
                        <td>{{ user[7] }}</td>
                        <td>{{ user[6] }}</td>
                        <td>
                            <span class="badge {% if user[11] == 'activo' %}bg-success{% elif user[11] == 'inactivo' %}bg-secondary{% else %}bg-warning{% endif %}">
                                {{ user[11] }}
                            </span>
                        </td>
                        <td>
                            <div class="progress" style="width: 60px;">
                                <div class="progress-bar {% if user[9]|int >= 80 %}bg-success{% elif user[9]|int >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                     role="progressbar" style="width: {{ user[9]|int }}%" aria-valuenow="{{ user[9]|int }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ user[9]|int }}%
                                </div>
                            </div>
                        </td>
                        <td>{{ user[10] }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-info action-btn" data-action="ver-perfil" data-user-id="{{ user[0] }}" title="Ver Perfil">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{{ url_for('gestion_humana.hoja_vida_empleado', empleado_id=user[0]) }}" class="btn btn-sm btn-secondary" title="Hoja de Vida">
                                    <i class="fas fa-id-card"></i>
                                </a>
                                <button class="btn btn-sm btn-warning action-btn" data-action="editar-usuario" data-user-id="{{ user[0] }}" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-primary action-btn" data-action="asignar-equipo" data-user-id="{{ user[0] }}" title="Asignar Equipo">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary action-btn" data-action="ver-historial" data-user-id="{{ user[0] }}" title="Historial">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn btn-sm btn-success action-btn" data-action="ver-soporte" data-user-id="{{ user[0] }}" title="Soporte">
                                    <i class="fas fa-headset"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <nav aria-label="Paginación de usuarios">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Anterior</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Añadir listeners a los botones de acción de la tabla
        const table = document.getElementById('usersTable');
        if (table) {
            table.addEventListener('click', function(event) {
                const button = event.target.closest('.action-btn');
                if (!button) return;

                const action = button.dataset.action;
                const userId = button.dataset.userId;

                if (!action || !userId) return;

                switch (action) {
                    case 'ver-perfil':      verPerfil(userId); break;
                    case 'editar-usuario':  editarUsuario(userId); break;
                    case 'asignar-equipo':  asignarEquipo(userId); break;
                    case 'ver-historial':   verHistorial(userId); break;
                    case 'ver-soporte':     verSoporte(userId); break;
                }
            });
        }
    });

    // Funciones de selección múltiple
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    document.getElementById('selectAllHeader').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        document.getElementById('selectAll').checked = this.checked;
    });

    // Funciones de acción
    function nuevoUsuario() {
        window.location.href = '{{ url_for("user.new_user") }}';
    }

    function editarUsuario(userId) {
        window.location.href = '{{ url_for("user.edit_user", user_id=0) }}'.replace('0', userId);
    }

    function verPerfil(userId) {
        // Implementar modal o página de perfil detallado
        alert('Funcionalidad de perfil en desarrollo - Usuario ID: ' + userId);
    }

    function asignarEquipo(userId) {
        window.location.href = '{{ url_for("inventarios.inventarios") }}';
    }

    function verHistorial(userId) {
        

    function verSoporte(userId) {
        window.location.href = '{{ url_for("mesa_ayuda.mesa_ayuda") }}';
    }

    function exportarSeleccionados(tipo) {
        const seleccionados = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (seleccionados.length === 0) {
            alert('Seleccione al menos un usuario');
            return;
        }
        alert(`Exportando ${seleccionados.length} usuarios en formato ${tipo.toUpperCase()}`);
        // Implementar lógica de exportación
    }

    function asignarEquiposSeleccionados() {
        const seleccionados = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (seleccionados.length === 0) {
            alert('Seleccione al menos un usuario');
            return;
        }
        alert(`Asignando equipos a ${seleccionados.length} usuarios`);
        // Implementar lógica de asignación múltiple
    }

    function desactivarSeleccionados() {
        const seleccionados = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (seleccionados.length === 0) {
            alert('Seleccione al menos un usuario');
            return;
        }
        if (confirm(`¿Desactivar ${seleccionados.length} usuarios seleccionados?`)) {
            // Implementar lógica de desactivación
            alert('Usuarios desactivados');
        }
    }

    function bloquearSeleccionados() {
        const seleccionados = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (seleccionados.length === 0) {
            alert('Seleccione al menos un usuario');
            return;
        }
        if (confirm(`¿Bloquear ${seleccionados.length} usuarios seleccionados?`)) {
            // Implementar lógica de bloqueo
            alert('Usuarios bloqueados');
        }
    }

    function eliminarSeleccionados() {
        const seleccionados = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
        if (seleccionados.length === 0) {
            alert('Seleccione al menos un usuario');
            return;
        }
        if (confirm(`¿Eliminar permanentemente ${seleccionados.length} usuarios seleccionados? Esta acción no se puede deshacer.`)) {
            // Implementar lógica de eliminación
            alert('Usuarios eliminados');
        }
    }
</script>
{% endblock %}
{% endblock %}
